<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAPI Widget - Ejemplo Avanzado</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f7fa;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 2rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h3 {
      color: #667eea;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .console-line {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid transparent;
    }

    .console-line.info {
      border-left-color: #61afef;
      color: #61afef;
    }

    .console-line.success {
      border-left-color: #98c379;
      color: #98c379;
    }

    .console-line.error {
      border-left-color: #e06c75;
      color: #e06c75;
    }

    .console-line.warning {
      border-left-color: #e5c07b;
      color: #e5c07b;
    }

    .stat-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .stat-label {
      color: #666;
      font-weight: 600;
    }

    .stat-value {
      color: #667eea;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s;
      margin: 5px;
    }

    .button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.active {
      background: #98c379;
      box-shadow: 0 0 8px #98c379;
    }

    .status-indicator.inactive {
      background: #e06c75;
    }

    .transcription-item {
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .transcription-meta {
      font-size: 0.85rem;
      color: #666;
      margin-top: 8px;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .config-label {
      font-weight: 600;
      color: #495057;
    }

    .config-value {
      font-family: 'Courier New', monospace;
      color: #667eea;
    }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé§ VAPI Widget - Ejemplo Avanzado</h1>
    <p>Demostraci√≥n con eventos, transcripciones y estad√≠sticas en tiempo real</p>
  </div>

  <div class="grid">
    <!-- Estado del Widget -->
    <div class="card">
      <h3>üìä Estado del Widget</h3>
      <div class="stat-box">
        <span class="stat-label">Estado:</span>
        <span class="stat-value" id="widget-status">
          <span class="status-indicator inactive"></span>
          Inactivo
        </span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Llamadas:</span>
        <span class="stat-value" id="call-count">0</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Transcripciones:</span>
        <span class="stat-value" id="transcript-count">0</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Duraci√≥n Total:</span>
        <span class="stat-value" id="total-duration">0s</span>
      </div>
    </div>

    <!-- Configuraci√≥n -->
    <div class="card">
      <h3>‚öôÔ∏è Configuraci√≥n VAPI</h3>
      <div class="config-item">
        <span class="config-label">Public Key:</span>
        <span class="config-value" id="public-key">a8e14149...</span>
      </div>
      <div class="config-item">
        <span class="config-label">Assistant ID:</span>
        <span class="config-value" id="assistant-id">901c39a3...</span>
      </div>
      <div class="config-item">
        <span class="config-label">Backend URL:</span>
        <span class="config-value">localhost:4000</span>
      </div>
      <div class="config-item">
        <span class="config-label">Tenant ID:</span>
        <span class="config-value">test-tenant-001</span>
      </div>
    </div>

    <!-- Controles -->
    <div class="card">
      <h3>üéÆ Controles</h3>
      <button class="button" onclick="testBackendConnection()">
        üîó Probar Conexi√≥n Backend
      </button>
      <button class="button" onclick="saveTranscription()">
        üíæ Guardar Transcripci√≥n
      </button>
      <button class="button" onclick="getStatistics()">
        üìà Obtener Estad√≠sticas
      </button>
      <button class="button" onclick="clearConsole()">
        üóëÔ∏è Limpiar Consola
      </button>
    </div>
  </div>

  <!-- Transcripciones -->
  <div class="card">
    <h3>üìù Transcripciones en Tiempo Real</h3>
    <div id="transcriptions">
      <p style="color: #999; text-align: center; padding: 20px;">
        No hay transcripciones todav√≠a. Habla con el asistente para empezar.
      </p>
    </div>
  </div>

  <!-- Consola de Eventos -->
  <div class="card">
    <h3>üñ•Ô∏è Consola de Eventos</h3>
    <div class="console" id="console"></div>
  </div>

  <a href="vapi-widget-demo.html" class="back-link">‚Üê Volver al Demo Simple</a>

  <!-- VAPI Widget -->
  <vapi-widget 
    assistant-id="901c39a3-a56f-4554-8d75-fb41d0c83e11" 
    public-key="a8e14149-23ab-405d-afb9-b0889aa1f58c">
  </vapi-widget>

  <script
    src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js"
    async
    type="text/javascript">
  </script>

  <script>
    // Configuraci√≥n
    const BACKEND_URL = 'http://localhost:4000';
    const API_KEY = 'vox_test_sk_1234567890abcdef';
    const TENANT_ID = 'test-tenant-001';
    const SESSION_ID = 'session-' + Date.now();

    // Estad√≠sticas
    let stats = {
      calls: 0,
      transcripts: 0,
      totalDuration: 0
    };

    // Funci√≥n para agregar l√≠nea a la consola
    function addToConsole(message, type = 'info') {
      const console = document.getElementById('console');
      const line = document.createElement('div');
      line.className = `console-line ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      line.textContent = `[${timestamp}] ${message}`;
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    // Funci√≥n para actualizar estad√≠sticas
    function updateStats() {
      document.getElementById('call-count').textContent = stats.calls;
      document.getElementById('transcript-count').textContent = stats.transcripts;
      document.getElementById('total-duration').textContent = stats.totalDuration + 's';
    }

    // Funci√≥n para agregar transcripci√≥n
    function addTranscription(text, confidence = 0.95) {
      const container = document.getElementById('transcriptions');
      
      // Remover mensaje de "no hay transcripciones"
      if (stats.transcripts === 0) {
        container.innerHTML = '';
      }

      const item = document.createElement('div');
      item.className = 'transcription-item';
      item.innerHTML = `
        <div><strong>${text}</strong></div>
        <div class="transcription-meta">
          Confianza: ${(confidence * 100).toFixed(1)}% ¬∑ 
          Hora: ${new Date().toLocaleTimeString()} ¬∑
          Sesi√≥n: ${SESSION_ID}
        </div>
      `;
      container.insertBefore(item, container.firstChild);
      
      stats.transcripts++;
      updateStats();
      addToConsole(`Nueva transcripci√≥n: "${text}"`, 'success');
    }

    // Probar conexi√≥n con backend
    async function testBackendConnection() {
      addToConsole('Probando conexi√≥n con backend...', 'info');
      try {
        const response = await fetch(`${BACKEND_URL}/transcription/health`);
        const data = await response.json();
        
        if (data.status === 'healthy' || data.status === 'degraded') {
          addToConsole(`‚úì Backend conectado: ${data.mode} mode`, 'success');
          document.getElementById('widget-status').innerHTML = 
            '<span class="status-indicator active"></span> Conectado';
        } else {
          addToConsole('‚ö† Backend en estado degradado', 'warning');
        }
      } catch (error) {
        addToConsole(`‚úó Error de conexi√≥n: ${error.message}`, 'error');
        document.getElementById('widget-status').innerHTML = 
          '<span class="status-indicator inactive"></span> Desconectado';
      }
    }

    // Guardar transcripci√≥n en backend
    async function saveTranscription() {
      const audioBlob = 'UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
      
      addToConsole('Guardando transcripci√≥n en backend...', 'info');
      
      try {
        const response = await fetch(`${BACKEND_URL}/transcription/segment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
          },
          body: JSON.stringify({
            sessionId: SESSION_ID,
            tenantId: TENANT_ID,
            audioBlob: audioBlob,
            format: 'wav',
            language: 'es-ES'
          })
        });

        const data = await response.json();
        addToConsole(`‚úì Transcripci√≥n guardada: ${data.segmentId}`, 'success');
        addTranscription(data.text, data.confidence);
      } catch (error) {
        addToConsole(`‚úó Error al guardar: ${error.message}`, 'error');
      }
    }

    // Obtener estad√≠sticas
    async function getStatistics() {
      addToConsole('Obteniendo estad√≠sticas...', 'info');
      try {
        const response = await fetch(`${BACKEND_URL}/transcription/stats?tenantId=${TENANT_ID}`);
        const data = await response.json();
        
        if (data.totalSegments !== undefined) {
          addToConsole(`üìä Estad√≠sticas: ${data.totalSegments} segmentos, ${data.totalDuration}s, $${data.totalCost}`, 'success');
        } else {
          addToConsole('‚ö† Requiere autenticaci√≥n JWT', 'warning');
        }
      } catch (error) {
        addToConsole(`‚úó Error: ${error.message}`, 'error');
      }
    }

    // Limpiar consola
    function clearConsole() {
      document.getElementById('console').innerHTML = '';
      addToConsole('Consola limpiada', 'info');
    }

    // Listener para eventos del widget VAPI (cuando est√© disponible)
    window.addEventListener('load', function() {
      addToConsole('Widget VAPI cargado', 'success');
      testBackendConnection();
      
      // Simular algunas transcripciones de ejemplo despu√©s de 2 segundos
      setTimeout(() => {
        addToConsole('Simulando transcripciones de ejemplo...', 'info');
        setTimeout(() => addTranscription('Hola, ¬øc√≥mo est√°s?', 0.96), 500);
        setTimeout(() => addTranscription('Necesito informaci√≥n sobre sus servicios', 0.94), 1500);
        setTimeout(() => addTranscription('¬øCu√°l es el horario de atenci√≥n?', 0.92), 2500);
      }, 2000);
    });

    // Actualizar configuraci√≥n en UI
    document.getElementById('public-key').textContent = 'a8e14149...b0889aa1f58c';
    document.getElementById('assistant-id').textContent = '901c39a3...fb41d0c83e11';
  </script>
</body>
</html>
