<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Google Speech-to-Text</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2em;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 0.9em;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 15px 30px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #startBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    #startBtn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    #stopBtn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    #stopBtn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(245, 87, 108, 0.4);
    }
    
    #clearBtn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    #clearBtn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4);
    }
    
    .recording-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .recording-indicator.active {
      display: flex;
    }
    
    .pulse {
      width: 15px;
      height: 15px;
      background: #dc3545;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }
    
    .transcript-container {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .transcript-header {
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }
    
    .transcript-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .transcript-time {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .transcript-text {
      color: #333;
      line-height: 1.6;
      margin-bottom: 5px;
    }
    
    .transcript-meta {
      display: flex;
      gap: 15px;
      font-size: 0.75em;
      color: #999;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .confidence-bar {
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #f5576c 0%, #ffc107 50%, #28a745 100%);
      transition: width 0.3s ease;
    }
    
    .empty-state {
      text-align: center;
      color: #999;
      padding: 60px 20px;
    }
    
    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }
    
    .config {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9em;
    }
    
    .config-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    
    .config-label {
      font-weight: 600;
      color: #0066cc;
    }
    
    .config-value {
      color: #333;
      font-family: 'Courier New', monospace;
    }
    
    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ Google Speech-to-Text Demo</h1>
    <p class="subtitle">Transcripci√≥n en tiempo real con Google Cloud</p>
    
    <div id="alert" class="alert"></div>
    
    <div class="config">
      <div class="config-row">
        <span class="config-label">Backend URL:</span>
        <span class="config-value" id="backendUrl">http://localhost:3000/api</span>
      </div>
      <div class="config-row">
        <span class="config-label">Session ID:</span>
        <span class="config-value" id="sessionId">-</span>
      </div>
      <div class="config-row">
        <span class="config-label">Formato Audio:</span>
        <span class="config-value">WEBM_OPUS (48kHz)</span>
      </div>
      <div class="config-row">
        <span class="config-label">Idioma:</span>
        <span class="config-value">es-ES (Espa√±ol)</span>
      </div>
    </div>
    
    <div class="recording-indicator" id="recordingIndicator">
      <div class="pulse"></div>
      <span><strong>Grabando...</strong> Habla ahora</span>
    </div>
    
    <div class="controls">
      <button id="startBtn">
        <span>üé§</span>
        <span>Iniciar Grabaci√≥n</span>
      </button>
      <button id="stopBtn" disabled>
        <span>‚èπÔ∏è</span>
        <span>Detener</span>
      </button>
      <button id="clearBtn">
        <span>üóëÔ∏è</span>
        <span>Limpiar</span>
      </button>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Segmentos</div>
        <div class="stat-value" id="segmentCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Duraci√≥n Total</div>
        <div class="stat-value" id="totalDuration">0s</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Costo Estimado</div>
        <div class="stat-value" id="totalCost">$0.000</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Confianza Media</div>
        <div class="stat-value" id="avgConfidence">-</div>
      </div>
    </div>
    
    <div class="transcript-container">
      <div class="transcript-header">üìù Transcripciones</div>
      <div id="transcriptList">
        <div class="empty-state">
          <div class="empty-state-icon">üéôÔ∏è</div>
          <p>Haz clic en "Iniciar Grabaci√≥n" para comenzar</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n
    const CONFIG = {
      API_URL: 'http://localhost:3000/api',
      API_KEY: 'your-api-key-here',  // ‚ö†Ô∏è CAMBIAR POR TU API KEY
      TENANT_ID: 'test-tenant-001',
      LANGUAGE: 'es-ES'
    };
    
    // Estado global
    const state = {
      sessionId: 'session-' + Date.now(),
      mediaRecorder: null,
      audioChunks: [],
      stats: {
        segments: 0,
        totalDuration: 0,
        totalCost: 0,
        totalConfidence: 0
      }
    };
    
    // Elementos DOM
    const elements = {
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      clearBtn: document.getElementById('clearBtn'),
      recordingIndicator: document.getElementById('recordingIndicator'),
      transcriptList: document.getElementById('transcriptList'),
      sessionIdDisplay: document.getElementById('sessionId'),
      segmentCount: document.getElementById('segmentCount'),
      totalDuration: document.getElementById('totalDuration'),
      totalCost: document.getElementById('totalCost'),
      avgConfidence: document.getElementById('avgConfidence'),
      backendUrl: document.getElementById('backendUrl'),
      alert: document.getElementById('alert')
    };
    
    // Inicializaci√≥n
    elements.sessionIdDisplay.textContent = state.sessionId;
    elements.backendUrl.textContent = CONFIG.API_URL;
    
    // Mostrar alerta
    function showAlert(message, type = 'success') {
      elements.alert.textContent = message;
      elements.alert.className = `alert alert-${type} show`;
      setTimeout(() => {
        elements.alert.classList.remove('show');
      }, 5000);
    }
    
    // Iniciar grabaci√≥n
    elements.startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000
          } 
        });
        
        // Verificar si el navegador soporta webm
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
          ? 'audio/webm;codecs=opus' 
          : 'audio/webm';
        
        state.mediaRecorder = new MediaRecorder(stream, {
          mimeType: mimeType,
          audioBitsPerSecond: 128000
        });
        
        state.mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            state.audioChunks.push(event.data);
          }
        };
        
        state.mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
          await sendToTranscription(audioBlob);
          state.audioChunks = [];
        };
        
        state.mediaRecorder.start();
        
        // UI updates
        elements.startBtn.disabled = true;
        elements.stopBtn.disabled = false;
        elements.recordingIndicator.classList.add('active');
        showAlert('Grabaci√≥n iniciada. Habla ahora...', 'success');
        
      } catch (error) {
        console.error('Error al acceder al micr√≥fono:', error);
        showAlert('No se pudo acceder al micr√≥fono. Verifica los permisos.', 'error');
      }
    });
    
    // Detener grabaci√≥n
    elements.stopBtn.addEventListener('click', () => {
      if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        state.mediaRecorder.stop();
        state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // UI updates
        elements.startBtn.disabled = false;
        elements.stopBtn.disabled = true;
        elements.recordingIndicator.classList.remove('active');
        showAlert('Procesando audio...', 'warning');
      }
    });
    
    // Limpiar transcripciones
    elements.clearBtn.addEventListener('click', () => {
      if (confirm('¬øEst√°s seguro de que quieres limpiar todas las transcripciones?')) {
        elements.transcriptList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üéôÔ∏è</div>
            <p>Haz clic en "Iniciar Grabaci√≥n" para comenzar</p>
          </div>
        `;
        
        state.stats = {
          segments: 0,
          totalDuration: 0,
          totalCost: 0,
          totalConfidence: 0
        };
        
        updateStats();
        showAlert('Transcripciones limpiadas', 'success');
      }
    });
    
    // Enviar audio a transcripci√≥n
    async function sendToTranscription(audioBlob) {
      try {
        // Convertir a Base64
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        
        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];
          
          // Enviar a backend
          const response = await fetch(`${CONFIG.API_URL}/transcription/segment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-API-Key': CONFIG.API_KEY
            },
            body: JSON.stringify({
              sessionId: state.sessionId,
              tenantId: CONFIG.TENANT_ID,
              audioBlob: base64Audio,
              format: 'webm',
              language: CONFIG.LANGUAGE
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            addTranscriptItem(result);
            updateStats(result);
            showAlert('Transcripci√≥n completada exitosamente', 'success');
          } else {
            console.error('Error:', result);
            showAlert(`Error: ${result.error || 'Error desconocido'}`, 'error');
          }
        };
        
        reader.onerror = () => {
          showAlert('Error al leer el archivo de audio', 'error');
        };
        
      } catch (error) {
        console.error('Error al transcribir:', error);
        showAlert(`Error de conexi√≥n: ${error.message}`, 'error');
      }
    }
    
    // A√±adir item de transcripci√≥n al DOM
    function addTranscriptItem(result) {
      // Eliminar empty state si existe
      const emptyState = elements.transcriptList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
      
      const item = document.createElement('div');
      item.className = 'transcript-item';
      
      const time = new Date(result.timestamp).toLocaleTimeString('es-ES');
      const confidence = (result.confidence * 100).toFixed(1);
      const duration = result.metadata?.duration?.toFixed(2) || '0.00';
      const cost = result.metadata?.cost?.toFixed(6) || '0.000000';
      
      item.innerHTML = `
        <div class="transcript-time">üïê ${time}</div>
        <div class="transcript-text">${result.text}</div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width: ${confidence}%"></div>
        </div>
        <div class="transcript-meta">
          <span>üìä Confianza: ${confidence}%</span>
          <span>‚è±Ô∏è Duraci√≥n: ${duration}s</span>
          <span>üí∞ Costo: $${cost}</span>
          <span>üîß ${result.metadata?.engine || 'unknown'}</span>
        </div>
      `;
      
      // Insertar al inicio de la lista
      elements.transcriptList.insertBefore(item, elements.transcriptList.firstChild);
    }
    
    // Actualizar estad√≠sticas
    function updateStats(result = null) {
      if (result) {
        state.stats.segments++;
        state.stats.totalDuration += result.metadata?.duration || 0;
        state.stats.totalCost += result.metadata?.cost || 0;
        state.stats.totalConfidence += result.confidence || 0;
      }
      
      elements.segmentCount.textContent = state.stats.segments;
      elements.totalDuration.textContent = state.stats.totalDuration.toFixed(1) + 's';
      elements.totalCost.textContent = '$' + state.stats.totalCost.toFixed(6);
      
      if (state.stats.segments > 0) {
        const avgConf = (state.stats.totalConfidence / state.stats.segments * 100).toFixed(1);
        elements.avgConfidence.textContent = avgConf + '%';
      } else {
        elements.avgConfidence.textContent = '-';
      }
    }
    
    // Verificar salud del servicio al cargar
    async function checkServiceHealth() {
      try {
        const response = await fetch(`${CONFIG.API_URL}/transcription/health`);
        const result = await response.json();
        
        if (result.status === 'ok') {
          const mode = result.mode === 'production' ? '‚úÖ Producci√≥n' : '‚ö†Ô∏è Mock';
          showAlert(`Servicio conectado: ${mode}`, result.mode === 'production' ? 'success' : 'warning');
        } else {
          showAlert('Servicio degradado', 'warning');
        }
      } catch (error) {
        showAlert('No se pudo conectar con el backend', 'error');
      }
    }
    
    // Inicializar
    checkServiceHealth();
  </script>
</body>
</html>
