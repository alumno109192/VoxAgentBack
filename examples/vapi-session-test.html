<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAPI Session Test - Voice Transcription</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .button-danger {
      background: #e74c3c;
      color: white;
    }

    .button-danger:hover:not(:disabled) {
      background: #c0392b;
    }

    .button-success {
      background: #27ae60;
      color: white;
    }

    .button-success:hover:not(:disabled) {
      background: #229954;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-info {
      background: #e8f4f8;
      color: #2c3e50;
      border-left: 4px solid #3498db;
    }

    .status-success {
      background: #e8f8f0;
      color: #27ae60;
      border-left: 4px solid #27ae60;
    }

    .status-error {
      background: #fdecea;
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }

    .transcription-box {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .transcript-item {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      background: white;
      border-left: 3px solid #667eea;
    }

    .transcript-item.partial {
      opacity: 0.7;
      border-left-color: #f39c12;
    }

    .transcript-item .time {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .transcript-item .text {
      color: #2c3e50;
      font-size: 15px;
    }

    .transcript-item .confidence {
      font-size: 11px;
      color: #95a5a6;
      margin-top: 5px;
    }

    .recording-indicator {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: #e74c3c;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .recording-indicator::before {
      content: '';
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 12px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé§ VAPI Session Test</h1>
      <p>Prueba de transcripci√≥n voz a texto con sesiones VAPI</p>
    </div>

    <div class="content">
      <!-- Configuraci√≥n -->
      <div class="section">
        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        <div class="config-grid">
          <div class="input-group">
            <label>API Key</label>
            <input type="text" id="apiKey" value="test-api-key-123" placeholder="Tu API Key">
          </div>
          <div class="input-group">
            <label>Tenant ID</label>
            <input type="text" id="tenantId" value="test-tenant-001" placeholder="Tu Tenant ID">
          </div>
          <div class="input-group">
            <label>Idioma</label>
            <select id="language">
              <option value="es-ES">Espa√±ol (Espa√±a)</option>
              <option value="es-MX">Espa√±ol (M√©xico)</option>
              <option value="en-US">English (US)</option>
              <option value="en-GB">English (UK)</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>Backend URL</label>
          <input type="text" id="backendUrl" value="http://localhost:4000" placeholder="http://localhost:4000">
        </div>
      </div>

      <!-- Estado -->
      <div class="section">
        <h2>üìä Estado de la Sesi√≥n</h2>
        <div id="statusBox" class="status status-info">
          Sesi√≥n no iniciada. Haz clic en "Iniciar Sesi√≥n" para comenzar.
        </div>
        
        <div id="recordingIndicator" style="display: none;" class="recording-indicator">
          üéôÔ∏è Grabando...
        </div>
      </div>

      <!-- Controles -->
      <div class="section">
        <h2>üéÆ Controles</h2>
        <button id="startSessionBtn" class="button button-primary">
          ‚ñ∂Ô∏è Iniciar Sesi√≥n
        </button>
        <button id="startRecordingBtn" class="button button-success" disabled>
          üé§ Grabar Audio
        </button>
        <button id="stopRecordingBtn" class="button button-danger" disabled>
          ‚èπÔ∏è Detener Grabaci√≥n
        </button>
        <button id="endSessionBtn" class="button button-danger" disabled>
          üõë Finalizar Sesi√≥n
        </button>
      </div>

      <!-- Transcripciones -->
      <div class="section">
        <h2>üìù Transcripciones</h2>
        <div id="transcriptionBox" class="transcription-box">
          <p style="text-align: center; color: #95a5a6; padding: 40px 0;">
            Las transcripciones aparecer√°n aqu√≠...
          </p>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="section">
        <h2>üìà Estad√≠sticas</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="value" id="statSegments">0</div>
            <div class="label">Segmentos</div>
          </div>
          <div class="stat-card">
            <div class="value" id="statWords">0</div>
            <div class="label">Palabras</div>
          </div>
          <div class="stat-card">
            <div class="value" id="statDuration">0s</div>
            <div class="label">Duraci√≥n</div>
          </div>
          <div class="stat-card">
            <div class="value" id="statConfidence">0%</div>
            <div class="label">Confianza Promedio</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Estado global
    let sessionId = null;
    let vapiSessionId = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let segmentCount = 0;
    let totalWords = 0;
    let totalDuration = 0;
    let confidences = [];
    let recordingStartTime = null;

    // Elementos DOM
    const apiKeyInput = document.getElementById('apiKey');
    const tenantIdInput = document.getElementById('tenantId');
    const languageSelect = document.getElementById('language');
    const backendUrlInput = document.getElementById('backendUrl');
    const statusBox = document.getElementById('statusBox');
    const transcriptionBox = document.getElementById('transcriptionBox');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const startSessionBtn = document.getElementById('startSessionBtn');
    const startRecordingBtn = document.getElementById('startRecordingBtn');
    const stopRecordingBtn = document.getElementById('stopRecordingBtn');
    const endSessionBtn = document.getElementById('endSessionBtn');

    // Generar session ID √∫nico
    function generateSessionId() {
      return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // Mostrar estado
    function showStatus(message, type = 'info') {
      statusBox.className = `status status-${type}`;
      statusBox.textContent = message;
    }

    // A√±adir transcripci√≥n
    function addTranscription(text, type, confidence, timestamp) {
      const item = document.createElement('div');
      item.className = `transcript-item ${type === 'partial' ? 'partial' : ''}`;
      
      const time = new Date(timestamp).toLocaleTimeString();
      const confPercent = confidence ? Math.round(confidence * 100) : 0;
      
      item.innerHTML = `
        <div class="time">${time} ${type === 'partial' ? '(parcial)' : ''}</div>
        <div class="text">${text}</div>
        ${confidence ? `<div class="confidence">Confianza: ${confPercent}%</div>` : ''}
      `;
      
      transcriptionBox.insertBefore(item, transcriptionBox.firstChild);
    }

    // Actualizar estad√≠sticas
    function updateStats() {
      document.getElementById('statSegments').textContent = segmentCount;
      document.getElementById('statWords').textContent = totalWords;
      document.getElementById('statDuration').textContent = `${totalDuration}s`;
      
      const avgConfidence = confidences.length > 0
        ? Math.round(confidences.reduce((a, b) => a + b, 0) / confidences.length * 100)
        : 0;
      document.getElementById('statConfidence').textContent = `${avgConfidence}%`;
    }

    // Iniciar sesi√≥n
    startSessionBtn.addEventListener('click', async () => {
      try {
        const apiKey = apiKeyInput.value;
        const tenantId = tenantIdInput.value;
        const language = languageSelect.value;
        const backendUrl = backendUrlInput.value;

        if (!apiKey || !tenantId) {
          alert('Por favor ingresa API Key y Tenant ID');
          return;
        }

        showStatus('Iniciando sesi√≥n...', 'info');
        sessionId = generateSessionId();

        const response = await fetch(`${backendUrl}/api/transcription/session/start`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
          },
          body: JSON.stringify({
            tenantId,
            sessionId,
            language,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Error al iniciar sesi√≥n');
        }

        vapiSessionId = data.vapiSessionId;
        showStatus(`‚úÖ Sesi√≥n iniciada: ${vapiSessionId}`, 'success');

        // Habilitar controles
        startSessionBtn.disabled = true;
        startRecordingBtn.disabled = false;
        endSessionBtn.disabled = false;

      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        console.error('Error starting session:', error);
      }
    });

    // Iniciar grabaci√≥n
    startRecordingBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'audio/webm;codecs=opus'
        });

        audioChunks = [];
        recordingStartTime = Date.now();

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          await sendAudioToVAPI(audioBlob, duration);
          
          // Detener tracks
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordingIndicator.style.display = 'inline-flex';
        startRecordingBtn.disabled = true;
        stopRecordingBtn.disabled = false;
        showStatus('üé§ Grabando audio...', 'info');

      } catch (error) {
        showStatus(`‚ùå Error al acceder al micr√≥fono: ${error.message}`, 'error');
        console.error('Error accessing microphone:', error);
      }
    });

    // Detener grabaci√≥n
    stopRecordingBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordingIndicator.style.display = 'none';
        startRecordingBtn.disabled = false;
        stopRecordingBtn.disabled = true;
        showStatus('‚èπÔ∏è Procesando audio...', 'info');
      }
    });

    // Enviar audio a VAPI
    async function sendAudioToVAPI(audioBlob, duration) {
      try {
        const reader = new FileReader();
        
        reader.onloadend = async () => {
          const base64Audio = reader.result.split(',')[1];
          const backendUrl = backendUrlInput.value;
          const apiKey = apiKeyInput.value;
          const tenantId = tenantIdInput.value;

          const response = await fetch(`${backendUrl}/api/transcription/vapi`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
            body: JSON.stringify({
              vapiSessionId,
              sessionId,
              tenantId,
              audioBlob: base64Audio,
              sequence: segmentCount,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Error al transcribir');
          }

          // A√±adir transcripci√≥n
          addTranscription(
            data.text,
            data.type,
            data.confidence,
            data.timestamp
          );

          // Actualizar estad√≠sticas solo si es final
          if (data.isFinal) {
            segmentCount++;
            totalWords += data.text.split(/\s+/).length;
            totalDuration += duration;
            if (data.confidence) {
              confidences.push(data.confidence);
            }
            updateStats();
          }

          showStatus(`‚úÖ Transcripci√≥n ${data.isFinal ? 'final' : 'parcial'} recibida`, 'success');
        };

        reader.readAsDataURL(audioBlob);

      } catch (error) {
        showStatus(`‚ùå Error al transcribir: ${error.message}`, 'error');
        console.error('Error sending audio:', error);
      }
    }

    // Finalizar sesi√≥n
    endSessionBtn.addEventListener('click', async () => {
      try {
        const backendUrl = backendUrlInput.value;
        const apiKey = apiKeyInput.value;
        const tenantId = tenantIdInput.value;

        showStatus('Finalizando sesi√≥n...', 'info');

        const response = await fetch(`${backendUrl}/api/transcription/session/end`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
          },
          body: JSON.stringify({
            vapiSessionId,
            sessionId,
            tenantId,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Error al finalizar sesi√≥n');
        }

        showStatus(`‚úÖ Sesi√≥n finalizada. Total de segmentos: ${data.totalSegments}`, 'success');

        // Resetear estado
        sessionId = null;
        vapiSessionId = null;
        startSessionBtn.disabled = false;
        startRecordingBtn.disabled = true;
        stopRecordingBtn.disabled = true;
        endSessionBtn.disabled = true;

      } catch (error) {
        showStatus(`‚ùå Error al finalizar sesi√≥n: ${error.message}`, 'error');
        console.error('Error ending session:', error);
      }
    });
  </script>
</body>
</html>
